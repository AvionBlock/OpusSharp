name: Opus Compile

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  Android:
    runs-on: ubuntu-latest
    env:
      CHECK_ALIGNMENT: false
    strategy:
      matrix:
        arch: [x64, x86, arm64, arm32]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28c
          add-to-path: false
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

        # Not much I can do to reduce the bloat.
      - name: Setup Environment
        run: |
          if [[ "${{ matrix.arch }}" == "x64" ]]; then
            echo "ABI=x86_64" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "x86" ]]; then
            echo "ABI=x86" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            echo "ABI=arm64-v8a" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "arm32" ]]; then
            echo "ABI=armeabi-v7a" >> $GITHUB_ENV
          fi

      - name: Create Build Directory
        run: mkdir build

      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.sh

      - name: Configure
        working-directory: ./build
        run: cmake ../opus -DCMAKE_TOOLCHAIN_FILE=${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake -DANDROID_ABI=${{ env.ABI }} -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON -DBUILD_TESTING=ON -DBUILD_SHARED_LIBS=ON -DCMAKE_SHARED_LINKER_FLAGS='-Wl,-z,max-page-size=16384,-z,common-page-size=16384' -DCMAKE_EXE_LINKER_FLAGS='-Wl,-z,max-page-size=16384,-z,common-page-size=16384'

      - name: Build
        working-directory: ./build
        run: cmake --build . -j 2 --config Release --target package

      - name: Check Alignment
        if: ${{ env.CHECK_ALIGNMENT == 'true' }}
        working-directory: ./build
        run: sudo apt install llvm && llvm-objdump -p libopus.so | grep LOAD

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.arch }}-libopus.so
          path: ./build/libopus.so

  Linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, x86, arm64, arm32]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

        # Not much I can do to reduce the bloat.
      - name: Setup Environment
        run: |
          if [[ "${{ matrix.arch }}" == "x64" ]]; then
            echo "C_FLAGS=-m64" >> $GITHUB_ENV
            echo "CXX_FLAGS=-m64" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "x86" ]]; then
            sudo apt-get update
            sudo apt-get install g++-multilib
            echo "C_FLAGS=-m32" >> $GITHUB_ENV
            echo "CXX_FLAGS=-m32" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            sudo apt-get update
            sudo apt-get install g++-aarch64-linux-gnu
            echo "C_COMPILER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
            echo "CXX_COMPILER=aarch64-linux-gnu-g++" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "arm32" ]]; then
            sudo apt-get update
            sudo apt-get install g++-arm-linux-gnueabi
            echo "C_COMPILER=arm-linux-gnueabi-gcc" >> $GITHUB_ENV
            echo "CXX_COMPILER=arm-linux-gnueabi-g++" >> $GITHUB_ENV
          fi

      - name: Create Build Directory
        run: mkdir build

      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.sh

      - name: Configure
        working-directory: ./build
        run: |
          if [[ "${{ matrix.arch }}" == "x64" || "${{ matrix.arch }}" == "x86" ]]; then
            cmake ../opus -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON -DCMAKE_C_FLAGS=${{ env.C_FLAGS }} -DCMAKE_CXX_FLAGS=${{ env.CXX_FLAGS }}
          elif [[ "${{ matrix.arch }}" == "arm64" || "${{ matrix.arch }}" == "arm32" ]]; then
            cmake ../opus -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON -DCMAKE_C_COMPILER=${{ env.C_COMPILER }} -DCMAKE_CXX_COMPILER=${{ env.CXX_COMPILER }}
          fi

      - name: Build
        working-directory: ./build
        run: cmake --build . -j 2 --config Release --target package

      - name: Rename file 
        working-directory: ./build
        run: mv libopus.so.0.11.0 opus.so

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-opus.so
          path: ./build/opus.so

  Windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86, arm64] # Disabled arm32
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

        # Not much I can do to reduce the bloat.
      - name: Setup Environment
        run: |
          if ( "${{ matrix.arch }}" -eq "x64" ) {
            echo "ARCH=x64" >> $env:GITHUB_ENV
          } elseif ( "${{ matrix.arch }}" -eq "x86" ) {
            echo "ARCH=Win32" >> $env:GITHUB_ENV
          } elseif ( "${{ matrix.arch }}" -eq "arm64" ) {
            echo "ARCH=ARM64" >> $env:GITHUB_ENV
          } elseif ( "${{ matrix.arch }}" -eq "arm32" ) {
            echo "ARCH=ARM" >> $env:GITHUB_ENV
          }

      - name: Create Build Directory
        run: mkdir build

      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.bat

      - name: Configure
        working-directory: ./build
        run: |
          if ( "${{ matrix.arch }}" -eq "arm32" ) {
            cmake ../opus -G "Visual Studio 17 2022" -A ARM,version=10.0.22621.0 -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON -DBUILD_TESTING=ON -DBUILD_SHARED_LIBS=ON
          }
          else {
            cmake ../opus -G "Visual Studio 17 2022" -A ${{ env.ARCH }} -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON -DBUILD_TESTING=ON -DBUILD_SHARED_LIBS=ON
          }

      - name: Build
        working-directory: ./build
        run: cmake --build . -j 2 --config Release --target package

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: win-${{ matrix.arch }}-opus.dll
          path: ./build/Release/opus.dll

  MacOS:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

        # Not much I can do to reduce the bloat.
      - name: Setup Environment
        run: |
          brew install autoconf automake libtool
          if [[ "${{ matrix.arch }}" == "x64" ]]; then
            echo "OSX_ARCH=x86_64" >> $GITHUB_ENV
          elif [[ "${{ matrix.arch }}" == "arm64" ]]; then
            echo "OSX_ARCH=arm64" >> $GITHUB_ENV
          fi

      - name: Create Build Directory
        run: mkdir build
        
      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.sh

      - name: Configure
        working-directory: ./build
        run: cmake ../opus -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DCMAKE_OSX_ARCHITECTURES=${{ env.OSX_ARCH }}

      - name: Build
        working-directory: ./build
        run: cmake --build .

      - name: Rename file 
        working-directory: ./build
        run: mv libopus.0.11.0.dylib opus.dylib

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
           name: macos-${{ matrix.arch }}-opus.dylib
           path: ./build/opus.dylib

  iOS:
    runs-on: macos-latest
    strategy:
      matrix:
        target: [device, simulator-arm64, simulator-x86_64]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          brew install autoconf automake libtool
          if [[ "${{ matrix.target }}" == "device" ]]; then
            echo "SDK=iphoneos" >> $GITHUB_ENV
            echo "ARCH=arm64" >> $GITHUB_ENV
            echo "OUTPUT_NAME=ios-device-arm64" >> $GITHUB_ENV
          elif [[ "${{ matrix.target }}" == "simulator-arm64" ]]; then
            echo "SDK=iphonesimulator" >> $GITHUB_ENV
            echo "ARCH=arm64" >> $GITHUB_ENV
            echo "OUTPUT_NAME=ios-simulator-arm64" >> $GITHUB_ENV
          elif [[ "${{ matrix.target }}" == "simulator-x86_64" ]]; then
            echo "SDK=iphonesimulator" >> $GITHUB_ENV
            echo "ARCH=x86_64" >> $GITHUB_ENV
            echo "OUTPUT_NAME=ios-simulator-x86_64" >> $GITHUB_ENV
          fi

      - name: Create Build Directory
        run: mkdir build

      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.sh

      - name: Configure
        working-directory: ./build
        run: |
          cmake ../opus \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=${{ env.ARCH }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_OSX_SYSROOT=${{ env.SDK }} \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DOPUS_BUILD_PROGRAMS=OFF \
            -DEC_PREFIX=opus_ec_ \
            -DEC_PREFIX_OVERRIDE=1

      - name: Build
        working-directory: ./build
        run: cmake --build . -j $(sysctl -n hw.ncpu) --config Release

      - name: Verify Library
        working-directory: ./build
        run: |
          echo "=== Built library for ${{ matrix.target }} ==="
          find . -name "*.a" -exec file {} \;
          find . -name "*.a" -exec lipo -info {} \;

      - name: Sanitize symbols to avoid Unity symbol conflicts (simplified)
        working-directory: ./build
        run: |
          echo "Installing llvm (provides llvm-objcopy)..."
          brew install llvm
          # Ensure llvm tools are on PATH for the remainder of this step
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"

          set -euo pipefail

          echo "Collecting global defined symbols from libopus.a..."
          # Select only defined symbols (T,D,B,S) from the archive and deduplicate
          nm -g libopus.a | awk '/ [TDBS] /{print $3}' | sort -u > allsyms.txt

          echo "Creating symbol mapping for renaming (skipping public 'opus' symbols)..."
          : > mapping.txt
          grep -v -E '^_opus' allsyms.txt | while read -r sym; do
            [ -z "$sym" ] && continue
            echo "$sym ${sym}_libopus" >> mapping.txt
          done

          if [ -s mapping.txt ]; then
            echo "Attempting archive-level objcopy rename (single step)..."

            # Try operating on the archive directly (faster). If the tool doesn't support archives,
            # fall back to extracting members and operating per-object (older llvm/objcopy may be limited).
            if llvm-objcopy --redefine-syms=mapping.txt libopus.a; then
              echo "Archive-level rename succeeded. Verifying..."
              nm -g libopus.a | grep compute_allocation || true
            else
              echo "Archive-level rename failed; falling back to per-object processing..."
              echo "Extracting libopus.a..."
              ar -x libopus.a
              echo "Applying symbol renames to object files..."
              for f in *.o; do
                llvm-objcopy --redefine-syms=mapping.txt "$f" || true
              done
              echo "Repacking sanitized lib into libopus_sanitized.a"
              ar rcs libopus_sanitized.a *.o
              echo "Verification: search for compute_allocation in sanitized archive (should be renamed or absent)"
              nm -g libopus_sanitized.a | grep compute_allocation || true
              mv libopus_sanitized.a libopus.a
            fi
          else
            echo "No non-opus symbols found to rename. Skipping sanitization."
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_NAME }}-libopus.a
          path: ./build/libopus.a

  iOS-universal:
    runs-on: macos-latest
    needs: iOS
    steps:
      - uses: actions/checkout@v4

      - name: Download device artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-device-arm64-libopus.a
          path: device

      - name: Download simulator-arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-simulator-arm64-libopus.a
          path: sim_arm64

      - name: Download simulator-x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-simulator-x86_64-libopus.a
          path: sim_x86

      - name: Create XCFramework (use available slices)
        run: |
          set -euo pipefail
          echo "Finding slices..."
          readarray -t slices < <(find device sim_arm64 sim_x86 -name "libopus.a")
          if [ ${#slices[@]} -eq 0 ]; then
            echo "No slices found! Listing directories:" && ls -la device sim_arm64 sim_x86 || true
            exit 1
          fi

          mkdir -p universal
          echo "Found slices:" && printf '%s' "${slices[@]}"

          # Build xcodebuild args for all available slices (headers come from checked out repo)
          xc_args=()
          for s in "${slices[@]}"; do
            xc_args+=( -library "$s" -headers "opus/include" )
          done

          echo "Creating XCFramework with xcodebuild..."
          if xcodebuild -create-xcframework "${xc_args[@]}" -output universal/libopus.xcframework; then
            echo "XCFramework created successfully."
            ls -la universal || true
          else
            echo "xcodebuild failed; attempting lipo fallback when possible..."
            if [ ${#slices[@]} -eq 1 ]; then
              cp "${slices[0]}" universal/libopus_universal.a
              echo "Copied single slice to universal/libopus_universal.a"
              lipo -info universal/libopus_universal.a || true
            else
              echo "Attempting lipo -create on available slices..."
              if lipo -create "${slices[@]}" -output universal/libopus_universal.a; then
                lipo -info universal/libopus_universal.a
              else
                echo "lipo failed; printing archs for inspection:" 
                for s in "${slices[@]}"; do
                  echo "$s -> $(lipo -info "$s")"
                done
                exit 1
              fi
            fi
          fi

      - name: Upload Universal Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-universal-libopus
          path: universal/*

  Wasm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: mymindstorm/setup-emsdk@v14

      - name: Create Build Dir
        run: mkdir build

      - name: Clone Repository
        run: git clone https://github.com/xiph/opus.git

      - name: Autogen
        run: ./opus/autogen.sh

      - name: Configure
        working-directory: ./build
        run: emcmake cmake ../opus -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=Release -DOPUS_BUILD_PROGRAMS=ON

      - name: Build
        working-directory: ./build
        run: cmake --build . -j 2 --config Release --target package

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
           name: wasm-libopus.a
           path: ./build/libopus.a
